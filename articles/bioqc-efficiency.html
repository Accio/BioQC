<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BioQC Algorithm: Speeding up the Wilcoxon-Mann-Whitney Test • BioQC</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="BioQC Algorithm: Speeding up the Wilcoxon-Mann-Whitney Test">
<meta property="og:description" content="BioQC">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">BioQC</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.19.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/BioQC.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/bioqc-efficiency.html">BioQC Algorithm: Speeding up the Wilcoxon-Mann-Whitney Test</a>
    </li>
    <li>
      <a href="../articles/bioqc-introduction.html">BioQC: Detect tissue heterogeneity in gene expression data</a>
    </li>
    <li>
      <a href="../articles/bioqc-signedGenesets.html">Using BioQC with signed genesets</a>
    </li>
    <li>
      <a href="../articles/bioqc-simulation.html">BioQC-benchmark: Testing Efficiency, Sensitivity and Specificity of BioQC on simulated and real-world data</a>
    </li>
    <li>
      <a href="../articles/bioqc-wmw-test-performance.html">Comparing the Wilcoxon-Mann-Whitney to alternative statistical tests</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="bioqc-efficiency_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>BioQC Algorithm: Speeding up the Wilcoxon-Mann-Whitney Test</h1>
                        <h4 class="author">Gregor Sturm and Jitao David Zhang</h4>
            
            <h4 class="date">2020-12-06</h4>
      
      
      <div class="hidden name"><code>bioqc-efficiency.Rmd</code></div>

    </div>

    
    
<p>In this vignette, we explain the underlaying algorithmic details of our implementation of the Wilcoxon-Mann-Whitney test. The source code used to produce this document can be found in the github repository <a href="https://github.com/Accio/BioQC/vignettes">BioQC</a>.</p>
<p><em>BioQC</em> is a R/Bioconductor package to detect tissue heterogeneity from high-throughput gene expression profiling data. It implements an efficient Wilcoxon-Mann-Whitney test, and offers tissue-specific gene signatures that are ready to use ‘out of the box’.</p>
<div id="algorithmic-improvements" class="section level2">
<h2 class="hasAnchor">
<a href="#algorithmic-improvements" class="anchor"></a>Algorithmic improvements</h2>
<p>The Wilcoxon-Mann-Whitney (WMW) test is a non-parametric statistical test to test if median values of two population are equal or not. Unlike the t-test, it does not require the assumption of normal distributions, which makes it more robust against noise.</p>
<p>We improved the computational efficiency of the Wilcoxon-Mann-Whitney test in comparison to the native R implementation based on three modifications:</p>
<ol style="list-style-type: decimal">
<li>The approximative WMW-statistic (Zar, J. H. (1999). Biostatistical analysis. Pearson Education India. <em>pp.</em> 174-177) is used. The differences to the exact version are negligible for high-throughput gene expression data.</li>
<li>The core algorithm is implemented in C instead of R as programming language.</li>
<li>BioQC avoids futile expensive sorting operations.</li>
</ol>
<p>While (1) and (2) are straightforward, we elaborate (3) in the following.</p>
<p>Let <span class="math inline">\(W_{a,b}\)</span> be the approximative WMW test of two gene vectors <span class="math inline">\(a,b\)</span>, where <span class="math inline">\(a\)</span> is the gene set of interest, typically containing less than a few hundreds of genes, and <span class="math inline">\(b\)</span> is the set of all genes outside the gene set (<em>background genes</em>) typically containing <span class="math inline">\(&gt;10000\)</span> genes. In the context of BioQC, the gene sets are referred to as <em>tissue signatures</em>.</p>
<p>Given an <span class="math inline">\(m \times n\)</span> input matrix of gene expression data with <span class="math inline">\(m\)</span> genes and <span class="math inline">\(n\)</span> samples <span class="math inline">\(s_1, \dots, s_n\)</span>, and <span class="math inline">\(k\)</span> gene sets <span class="math inline">\(d_1, \dots, d_k\)</span>, the WMW-test needs to be applied for each sample <span class="math inline">\(s_i, i \in 1..n\)</span> and each gene set <span class="math inline">\(d_j, j \in 1..k\)</span>. The runtime of the WMW-test is essentially determined by the sorting operation on the two input vectors. Using native R <code>wilcox.test</code>, the vectors <span class="math inline">\(a\)</span> and <span class="math inline">\(b\)</span> are sorted individually for each gene set. However, in the context of gene set analysis, this is futile, as the (large) background set changes insignificantly in relation to the (small) gene set, when testing different gene sets on the same sample.</p>
<p>Therefore, we approximate the WMW-test by extending <span class="math inline">\(b\)</span> to all genes in the sample, keeping the background unchanged when testing multiple gene sets. Like this, <span class="math inline">\(b\)</span> has to be sorted only once per sample. The individual gene sets still need to be sorted, which is not a major issue, as they are small in comparison to the set of background genes.</p>
<div class="figure" style="text-align: center">
<img src="wmw-speedup.png" alt="BioQC speeds up the Wilcoxon-Mann-Whitney test by avoiding futile sorting operations on the same sample." width="500" style="display:block; margin: auto"><p class="caption">
BioQC speeds up the Wilcoxon-Mann-Whitney test by avoiding futile sorting operations on the same sample.
</p>
</div>
</div>
<div id="time-benchmark" class="section level2">
<h2 class="hasAnchor">
<a href="#time-benchmark" class="anchor"></a>Time benchmark</h2>
<p>To demonstrate BioQC’s superior performance, we apply both BioQC and the native R <code>wilcox.test</code> to random expression matrices and measure the runtime.</p>
<p>We setup random expression matrices of 61538 human genes of 1, 5, 10, 50, or 100 samples. Genes are <span class="math inline">\(i.i.d\)</span> distributed following <span class="math inline">\(\mathcal{N}(0,1)\)</span>. The native R and the <em>BioQC</em> implementations of the Wilcoxon-Mann-Whitney test are applied to the matrices respectively.</p>
<p>The numeric results of both implementations, <code>bioqcNumRes</code> (from <em>BioQC</em>) and <code>rNumRes</code> (from <em>R</em>), are equivalent, as shown by the next command.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">expect_equal</span><span class="op">(</span><span class="va">bioqcNumRes</span>, <span class="va">rNumRes</span><span class="op">)</span></code></pre></div>
<p>The <em>BioQC</em> implementation is more than 500 times faster: while it takes about one second for BioQC to calculate enrichment scores of all 155 signatures in 100 samples, the native R implementation takes about 20 minutes:</p>
<div class="figure" style="text-align: center">
<img src="bioqc-efficiency_files/figure-html/time_benchmark_vis-1.png" alt="**Figure 2**: Time benchmark results of BioQC and R implementation of Wilcoxon-Mann-Whitney test. Left panel: elapsed time in seconds (logarithmic Y-axis). Right panel: ratio of elapsed time by two implementations. All results achieved by a single thread on in a RedHat Linux server." width="768" style="display:block; margin: auto"><p class="caption">
<strong>Figure 2</strong>: Time benchmark results of BioQC and R implementation of Wilcoxon-Mann-Whitney test. Left panel: elapsed time in seconds (logarithmic Y-axis). Right panel: ratio of elapsed time by two implementations. All results achieved by a single thread on in a RedHat Linux server.
</p>
</div>
</div>
<div id="conclusion" class="section level2">
<h2 class="hasAnchor">
<a href="#conclusion" class="anchor"></a>Conclusion</h2>
<p>We have shown that <em>BioQC</em> achieves identical results as the native implementation in two orders of magnitude less time. This renders <em>BioQC</em> a highly efficient tool for quality control of large-scale high-throughput gene expression data.</p>
</div>
<div id="r-session-info" class="section level2">
<h2 class="hasAnchor">
<a href="#r-session-info" class="anchor"></a>R Session Info</h2>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## R Under development (unstable) (2020-12-04 r79554)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 20.04.1 LTS
## 
## Matrix products: default
## BLAS/LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.8.so
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=C             
##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] stats4    parallel  stats     graphics  grDevices utils     datasets 
## [8] methods   base     
## 
## other attached packages:
##  [1] rbenchmark_1.0.0     gplots_3.1.1         gridExtra_2.3       
##  [4] latticeExtra_0.6-29  lattice_0.20-41      org.Hs.eg.db_3.12.0 
##  [7] AnnotationDbi_1.53.0 IRanges_2.25.4       S4Vectors_0.29.5    
## [10] BioQC_1.19.2         Biobase_2.51.0       BiocGenerics_0.37.0 
## [13] testthat_3.0.0       knitr_1.30          
## 
## loaded via a namespace (and not attached):
##  [1] gtools_3.8.2       locfit_1.5-9.4     xfun_0.19          vctrs_0.3.5       
##  [5] htmltools_0.5.0    yaml_2.2.1         blob_1.2.1         rlang_0.4.9       
##  [9] pkgdown_1.6.1.9000 withr_2.3.0        DBI_1.1.0          bit64_4.0.5       
## [13] RColorBrewer_1.1-2 jpeg_0.1-8.1       stringr_1.4.0      gtable_0.3.0      
## [17] ragg_0.4.0         caTools_1.18.0     memoise_1.1.0      evaluate_0.14     
## [21] highr_0.8          Rcpp_1.0.5         KernSmooth_2.23-18 edgeR_3.33.0      
## [25] limma_3.47.1       desc_1.2.0         pkgload_1.1.0      systemfonts_0.3.2 
## [29] fs_1.5.0           bit_4.0.4          textshaping_0.2.1  png_0.1-7         
## [33] digest_0.6.27      stringi_1.5.3      grid_4.1.0         rprojroot_2.0.2   
## [37] tools_4.1.0        bitops_1.0-6       magrittr_2.0.1     RSQLite_2.2.1     
## [41] crayon_1.3.4       pkgconfig_2.0.3    assertthat_0.2.1   rmarkdown_2.5     
## [45] R6_2.5.0           compiler_4.1.0</code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jitao David Zhang, Laura Badi, Gregor Sturm, Roland Ambs, Iakov Davydov.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
